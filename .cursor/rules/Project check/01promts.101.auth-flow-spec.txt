# SafeMeals 인증 & 온보딩 흐름 명세서

> **작성일**: 2025-12-31
> **버전**: 1.0.0
> **적용 범위**: Mobile App (Expo) & Web (Next.js)

---

## 📋 목차

1. [전체 흐름도](#전체-흐름도)
2. [앱 시작 흐름](#1-앱-시작-흐름)
3. [로그인 흐름](#2-로그인-흐름)
4. [회원가입 흐름](#3-회원가입-흐름)
5. [온보딩 흐름](#4-온보딩-흐름)
6. [재방문 흐름](#5-재방문-흐름)
7. [로그아웃 흐름](#6-로그아웃-흐름)
8. [기술 구현 상세](#기술-구현-상세)
9. [상태 관리](#상태-관리)

---

## 전체 흐름도

```
┌─────────────────┐
│   앱 시작       │
│  (App Launch)   │
└────────┬────────┘
         │
         ▼
┌─────────────────────┐
│  토큰 확인          │
│  AsyncStorage       │
│  - authToken        │
│  - hasOnboarded     │
└─────────┬───────────┘
          │
    ┌─────┴─────┐
    │           │
    ▼           ▼
[토큰 없음]  [토큰 있음]
    │           │
    ▼           └────┬─────┐
로그인 페이지        │     │
    │          [온보딩  [온보딩
    │           미완료]  완료]
    ▼              │      │
회원가입 선택       ▼      ▼
    │          온보딩  메인 화면
    ▼          페이지
회원가입 완료
    │
    ▼
로그인 성공
    │
    ▼
토큰 저장
    │
    ▼
온보딩 페이지
    │
    ▼
온보딩 완료
    │
    ▼
메인 화면
```

---

## 1. 앱 시작 흐름

### 1.1 시작 조건
- 사용자가 앱 아이콘을 탭하여 실행
- 앱이 백그라운드에서 포그라운드로 전환 (이미 실행 중인 경우)

### 1.2 처리 단계

```typescript
// apps/mobile/app/index.tsx

1. AsyncStorage에서 데이터 확인
   - authToken: 로그인 토큰
   - hasOnboarded: 온보딩 완료 여부

2. 조건에 따른 화면 분기
   ├─ authToken 없음 → 로그인 페이지 (/(auth)/login)
   ├─ authToken 있음 + hasOnboarded 없음 → 온보딩 (/(auth)/onboarding)
   └─ authToken 있음 + hasOnboarded 있음 → 메인 화면 (/(tabs))
```

### 1.3 구현 코드 위치

| 파일 | 역할 |
|------|------|
| `apps/mobile/app/index.tsx` | 앱 진입점, 인증 상태 확인 |
| `apps/mobile/app/(auth)/_layout.tsx` | 인증 관련 라우트 레이아웃 |

### 1.4 체크리스트

- [ ] AsyncStorage 읽기 권한 확인
- [ ] 네트워크 연결 상태 확인 (옵션)
- [ ] 스플래시 화면 표시 (로딩 중)
- [ ] 토큰 만료 검증 (향후 추가)

---

## 2. 로그인 흐름

### 2.1 진입 조건
- `authToken`이 AsyncStorage에 없는 경우
- 사용자가 로그아웃한 경우
- 세션이 만료된 경우

### 2.2 처리 단계

```typescript
// apps/mobile/app/(auth)/login.tsx
// apps/web/src/app/auth/login/page.tsx

1. 로그인 페이지 표시
   ├─ 이메일 입력 필드
   ├─ 비밀번호 입력 필드
   ├─ 로그인 버튼
   └─ 회원가입 버튼

2. 사용자 입력
   - 이메일 유효성 검증
   - 비밀번호 최소 6자 검증

3. 로그인 요청
   - Supabase Auth API 호출
   - signInWithPassword(email, password)

4. 성공 시
   ├─ 웹: router.push(MAIN_URLS.DASHBOARD)
   └─ 모바일: SafeMealsBridge.postMessage('LOGIN_SUCCESS')

5. 모바일 토큰 저장
   ├─ AsyncStorage.setItem('authToken', token)
   ├─ AsyncStorage.setItem('refreshToken', refreshToken)
   ├─ AsyncStorage.setItem('userId', userId)
   └─ AsyncStorage.setItem('hasOnboarded', 'true')

6. 화면 전환
   ├─ hasOnboarded 없음 → 온보딩 (/(auth)/onboarding)
   └─ hasOnboarded 있음 → 메인 화면 (/(tabs))
```

### 2.3 구현 코드 위치

| 파일 | 역할 |
|------|------|
| `apps/web/src/hooks/useLogin.ts` | 로그인 로직 (Supabase) |
| `apps/web/src/features/auth/components/login-form/` | 로그인 폼 UI |
| `apps/mobile/components/WebViewScreen.tsx` | 웹뷰 브릿지 (LOGIN_SUCCESS 처리) |

### 2.4 WebView Bridge 메시지

```typescript
// 웹 → 네이티브 메시지
{
  type: 'LOGIN_SUCCESS',
  payload: {
    token: string,        // access_token
    refreshToken: string, // refresh_token
    userId: string        // user.id
  }
}
```

### 2.5 에러 처리

| 에러 케이스 | 처리 방법 |
|------------|----------|
| 잘못된 이메일/비밀번호 | "이메일 또는 비밀번호가 올바르지 않습니다." 표시 |
| 네트워크 오류 | "네트워크 연결을 확인해주세요." 표시 |
| 서버 오류 | "잠시 후 다시 시도해주세요." 표시 |

---

## 3. 회원가입 흐름

### 3.1 진입 조건
- 로그인 페이지에서 "회원가입" 버튼 클릭
- 직접 `/auth/signup` 경로 접근

### 3.2 처리 단계

```typescript
// apps/web/src/app/auth/signup/page.tsx

1. 회원가입 폼 표시
   ├─ 이메일 입력
   ├─ 비밀번호 입력
   ├─ 비밀번호 확인
   └─ 이용약관 동의

2. 입력 검증
   ├─ 이메일 형식 확인
   ├─ 비밀번호 강도 확인 (최소 6자)
   └─ 비밀번호 일치 확인

3. 회원가입 요청
   - Supabase Auth API 호출
   - signUp(email, password)

4. 성공 시
   - 이메일 인증 안내 (옵션)
   - 자동 로그인 or 로그인 페이지로 이동

5. 로그인 후 온보딩으로 이동
```

### 3.3 구현 코드 위치

| 파일 | 역할 |
|------|------|
| `apps/web/src/app/auth/signup/page.tsx` | 회원가입 페이지 |
| `apps/web/src/features/auth/components/signup-form/` | 회원가입 폼 |

---

## 4. 온보딩 흐름

### 4.1 진입 조건
- 회원가입 후 첫 로그인
- `authToken`은 있지만 `hasOnboarded`가 없는 경우

### 4.2 처리 단계

```typescript
// apps/mobile/app/(auth)/onboarding.tsx
// apps/web/src/app/onboarding/allergy/page.tsx

1. 알러지 선택 페이지
   ├─ /onboarding/allergy
   ├─ 주요 알러지 항목 표시 (땅콩, 우유, 계란 등)
   └─ "다음" 버튼

2. 알러지 상세 선택 (옵션)
   ├─ /onboarding/allergy-detail
   └─ 추가 알러지 정보 입력

3. 식단 선택 페이지
   ├─ /onboarding/diet
   ├─ 식단 유형 선택 (채식, 비건, 할랄 등)
   └─ "다음" 버튼

4. 식단 상세 선택 (옵션)
   ├─ /onboarding/diet-detail
   └─ 추가 식단 정보 입력

5. 온보딩 완료
   ├─ AsyncStorage.setItem('hasOnboarded', 'true')
   └─ 메인 화면으로 이동 (/(tabs))
```

### 4.3 구현 코드 위치

| 파일 | 역할 |
|------|------|
| `apps/web/src/app/onboarding/allergy/page.tsx` | 알러지 선택 |
| `apps/web/src/app/onboarding/diet/page.tsx` | 식단 선택 |
| `apps/mobile/app/(auth)/onboarding.tsx` | 모바일 온보딩 진입점 |

### 4.4 페이지 네비게이션

```
/onboarding/allergy
    ↓
/onboarding/allergy-detail (선택)
    ↓
/onboarding/diet
    ↓
/onboarding/diet-detail (선택)
    ↓
완료 → /(tabs)
```

---

## 5. 재방문 흐름

### 5.1 시작 조건
- 앱을 종료 후 재실행
- 백그라운드에서 포그라운드로 전환

### 5.2 처리 단계

```typescript
1. AsyncStorage 확인
   ├─ authToken 확인
   └─ hasOnboarded 확인

2. 조건 분기
   ├─ 둘 다 있음 → 메인 화면 (/(tabs))
   ├─ authToken만 있음 → 온보딩 (/(auth)/onboarding)
   └─ 둘 다 없음 → 로그인 (/(auth)/login)

3. 토큰 유효성 검증 (향후 추가)
   - 만료된 경우 → refreshToken으로 갱신
   - 갱신 실패 시 → 로그인 페이지
```

### 5.3 최적화

- [ ] 토큰 만료 시간 확인 (JWT 디코딩)
- [ ] 백그라운드에서 자동 갱신
- [ ] 오프라인 모드 지원

---

## 6. 로그아웃 흐름

### 6.1 진입 조건
- 사용자가 "로그아웃" 버튼 클릭
- 보안상 강제 로그아웃 필요 시

### 6.2 처리 단계

```typescript
1. 로그아웃 확인 다이얼로그
   - "정말 로그아웃하시겠습니까?"

2. 확인 시
   ├─ Supabase signOut() 호출
   ├─ AsyncStorage.removeItem('authToken')
   ├─ AsyncStorage.removeItem('refreshToken')
   ├─ AsyncStorage.removeItem('userId')
   └─ AsyncStorage.removeItem('hasOnboarded') (선택)

3. 로그인 페이지로 이동
   - router.replace('/(auth)/login')
```

### 6.3 주의사항

- `hasOnboarded`는 유지할 수도 있음 (재로그인 시 온보딩 스킵)
- 민감한 데이터는 반드시 삭제

---

## 기술 구현 상세

### AsyncStorage 키 정의

```typescript
// 저장되는 키 목록
const STORAGE_KEYS = {
  AUTH_TOKEN: 'authToken',        // Supabase access_token
  REFRESH_TOKEN: 'refreshToken',  // Supabase refresh_token
  USER_ID: 'userId',              // user.id
  HAS_ONBOARDED: 'hasOnboarded',  // 'true' | null
} as const;
```

### WebView Bridge 메시지 타입

```typescript
// 웹 → 네이티브 메시지
type WebToNativeMessage =
  | { type: 'LOGIN_SUCCESS', payload: { token, refreshToken, userId } }
  | { type: 'LOGOUT' }
  | { type: 'ONBOARDING_COMPLETE' }
  | { type: 'NAVIGATE', payload: { screen: string } };

// 네이티브 → 웹 메시지 (향후)
type NativeToWebMessage =
  | { type: 'TOKEN_EXPIRED' }
  | { type: 'NETWORK_ERROR' };
```

### 라우팅 구조

```
apps/mobile/app/
├── index.tsx                    # 앱 진입점 (인증 체크)
├── (auth)/
│   ├── _layout.tsx              # 인증 레이아웃
│   ├── login.tsx                # 로그인 (WebView)
│   ├── signup.tsx               # 회원가입 (WebView)
│   └── onboarding.tsx           # 온보딩 (WebView)
└── (tabs)/
    ├── _layout.tsx              # 메인 레이아웃
    ├── index.tsx                # 홈
    ├── scan.tsx                 # 스캔
    ├── safety-card.tsx          # 안전카드
    └── profile.tsx              # 프로필
```

---

## 상태 관리

### 인증 상태 흐름

```
┌─────────────┐
│ INITIAL     │ (앱 시작)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ LOADING     │ (AsyncStorage 확인 중)
└──────┬──────┘
       │
   ┌───┴────┐
   ▼        ▼
┌──────┐ ┌────────────┐
│GUEST │ │AUTHENTICATED│
└──────┘ └─────┬──────┘
   │           │
   │      ┌────┴─────┐
   │      ▼          ▼
   │  ┌────────┐ ┌────────┐
   │  │ONBOARD │ │COMPLETE│
   │  │PENDING │ │        │
   │  └────────┘ └────────┘
   │      │          │
   └──────┴──────────┘
          │
          ▼
   ┌─────────────┐
   │ LOGGED_OUT  │
   └─────────────┘
```

---

## 체크리스트

### 로그인 기능
- [x] 이메일/비밀번호 유효성 검증
- [x] Supabase 인증 연동
- [x] 웹뷰 브릿지 메시지 전송
- [x] AsyncStorage 토큰 저장
- [x] 에러 메시지 표시

### 온보딩 기능
- [x] 알러지 선택 페이지
- [x] 식단 선택 페이지
- [ ] 온보딩 완료 플래그 저장
- [ ] 데이터 서버 동기화

### 인증 상태 관리
- [x] 앱 시작 시 토큰 확인
- [x] 조건에 따른 라우팅
- [ ] 토큰 만료 검증
- [ ] 자동 갱신 (Refresh Token)

### 보안
- [ ] HTTPS 통신 강제
- [ ] 토큰 암호화 저장 (선택)
- [ ] 생체 인증 추가 (선택)
- [ ] 세션 타임아웃 처리

---

## 참고 자료

### 관련 파일
- `apps/mobile/app/index.tsx` - 앱 진입점
- `apps/web/src/hooks/useLogin.ts` - 로그인 훅
- `apps/mobile/components/WebViewScreen.tsx` - 웹뷰 브릿지

### 외부 문서
- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Expo Router Documentation](https://docs.expo.dev/router/introduction/)
- [AsyncStorage API](https://react-native-async-storage.github.io/async-storage/)

---

## 버전 히스토리

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 1.0.0 | 2025-12-31 | 초기 작성 - 기본 인증 흐름 정의 |

---

**문서 관리자**: Development Team
**마지막 업데이트**: 2025-12-31
